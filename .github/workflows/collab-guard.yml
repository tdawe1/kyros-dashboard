name: Collab Guard
on: [pull_request]
jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need full history for comparisons

      # Enforce develop as PR base branch (allow release sync PRs)
      - name: Check PR base branch
        run: |
          if [ "${{ github.base_ref }}" = "main" ] && [ "${{ github.head_ref }}" = "develop" ]; then
            echo "✅ Release sync PR from 'develop' to 'main' allowed"
            exit 0
          fi
          if [ "${{ github.base_ref }}" != "develop" ]; then
            echo "❌ PRs must target 'develop' branch, not '${{ github.base_ref }}'"
            echo "If this is a release, open PR from 'develop' to 'main' only."
            exit 1
          else
            echo "✅ PR correctly targets 'develop' branch"
          fi

      # Ensure PR branch is up-to-date with base (develop)
      - name: Check branch is up-to-date with base
        run: |
          git fetch origin "${{ github.base_ref }}:${{ github.base_ref }}"
          BEHIND=$(git rev-list --left-right --count "${{ github.base_ref }}...${{ github.sha }}" | awk '{print $1}')
          echo "Commits behind base '${{ github.base_ref }}': ${BEHIND:-0}"
          if [ "${BEHIND:-0}" -gt 0 ]; then
            echo "❌ Branch is behind '${{ github.base_ref }}' by ${BEHIND} commits."
            echo "Please click 'Update branch' (preferred) or rebase onto '${{ github.base_ref }}'."
            exit 1
          else
            echo "✅ Branch is up-to-date with base"
          fi

      # Size guard - check for large PRs
      - name: Check PR size
        id: pr_size
        run: |
          TOTAL_LINES=$(git diff --numstat "${{ github.base_ref }}...HEAD" \
            | awk '{a=$1; d=$2; if (a ~ /^[0-9]+$/) add+=a; if (d ~ /^[0-9]+$/) del+=d} END {print add+del+0}')
          echo "Total lines changed: ${TOTAL_LINES:-0}"
          if [ "${TOTAL_LINES:-0}" -gt 1000 ]; then
            echo "❌ PR is too large: $TOTAL_LINES lines changed (limit: 1000)"
            echo "Please split this PR into smaller, more manageable chunks."
            echo "Consider breaking down by feature or logical component."
            echo "total_lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"
            echo "is_large=true" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "✅ PR size is acceptable: $TOTAL_LINES lines changed"
            echo "total_lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"
            echo "is_large=false" >> "$GITHUB_OUTPUT"
          fi

      # Add needs-split label for large PRs
      - name: Add needs-split label for large PRs
        if: steps.pr_size.outputs.is_large == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-split']
            })

      - name: No conflict markers
        run: |
          ! grep -R --line-number -E '^(<<<<<<<|=======|>>>>>>>)' . --exclude-dir=venv --exclude-dir=.venv --exclude-dir=node_modules || \
            (echo "Conflict markers found"; exit 1)

      - name: Validate JSON
        run: |
          python - <<'PY'
import json, sys, pathlib
ok=True
skip_files = {'tsconfig.json', 'tsconfig.node.json', 'package-lock.json'}
for p in pathlib.Path('.').rglob('*.json'):
    if 'venv' in str(p) or 'node_modules' in str(p) or p.name in skip_files:
        continue
    try:
        json.loads(p.read_text())
        print(f'✓ Valid JSON: {p}')
    except Exception as e:
        print(f'✗ Invalid JSON: {p}: {e}'); ok=False
sys.exit(0 if ok else 1)
PY

      - name: Validate YAML (plans)
        run: |
          python - <<'PY'
import sys, pathlib, yaml
ok=True
for p in pathlib.Path('collaboration/plans').rglob('*.yml'):
    try:
        yaml.safe_load(p.read_text())
    except Exception as e:
        print(f'Invalid YAML: {p}: {e}'); ok=False
sys.exit(0 if ok else 1)
PY
